{
  "id": "standard_architecture_command_rules",
  "version": "1.1.0",
  "title": "Architecture Standard \u2013 Command Patterns",
  "type": "policy",
  "status": "active",
  "owners": {
    "accountable": "Architecture Owner",
    "responsible": [
      "Core Maintainer"
    ]
  },
  "review": {
    "frequency": "12 months"
  },
  "schema_id": "schema.policy",
  "description": "Defines the canonical patterns for all CORE CLI commands.\nEvery command MUST follow one of these patterns to ensure consistency,\nsafety, and predictability across the system.\n",
  "rules": [
    {
      "id": "workflow_composition.chain_action_pattern",
      "category": "workflow_composition",
      "rationale": "Strengthens system governance regarding workflow_composition.chain_action_pattern.",
      "enforcement": "error",
      "statement": "Workflows can chain multiple action_pattern commands",
      "check": {
        "engine": "llm_gate",
        "params": {
          "instruction": "Verify adherence to: Workflows can chain multiple action_pattern commands"
        }
      }
    },
    {
      "id": "workflow_composition.step_must_succeed",
      "category": "workflow_composition",
      "rationale": "Strengthens system governance regarding workflow_composition.step_must_succeed.",
      "enforcement": "error",
      "statement": "Each step must succeed before proceeding to next",
      "check": {
        "engine": "llm_gate",
        "params": {
          "instruction": "Verify adherence to: Each step must succeed before proceeding to next"
        }
      }
    },
    {
      "id": "workflow_composition.idempotent",
      "category": "workflow_composition",
      "rationale": "Strengthens system governance regarding workflow_composition.idempotent.",
      "enforcement": "error",
      "statement": "Workflows should be idempotent (safe to re-run)",
      "check": {
        "engine": "llm_gate",
        "params": {
          "instruction": "Verify adherence to: Workflows should be idempotent (safe to re-run)"
        }
      }
    },
    {
      "id": "workflow_composition.progress_indication",
      "category": "workflow_composition",
      "rationale": "Strengthens system governance regarding workflow_composition.progress_indication.",
      "enforcement": "error",
      "statement": "Workflows should provide clear progress indication",
      "check": {
        "engine": "llm_gate",
        "params": {
          "instruction": "Verify adherence to: Workflows should provide clear progress indication"
        }
      }
    },
    {
      "id": "workflow_composition.fail_fast",
      "category": "workflow_composition",
      "rationale": "Strengthens system governance regarding workflow_composition.fail_fast.",
      "enforcement": "error",
      "statement": "Workflows should fail fast on errors",
      "check": {
        "engine": "llm_gate",
        "params": {
          "instruction": "Verify adherence to: Workflows should fail fast on errors"
        }
      }
    },
    {
      "id": "cli.runtime.single_loop_owner",
      "category": "cli_runtime",
      "rationale": "CLI commands must execute deterministically in a single owned event loop. Returning Tasks from sync Typer entrypoints leads to un-awaited execution and loop leakage.",
      "enforcement": "error",
      "statement": "CLI commands MUST execute inside a single owned event loop via the CORE runtime boundary. Sync Typer entrypoints MUST NOT return asyncio Task objects or schedule background tasks as the command result.",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "no_task_return_from_sync_cli"
        }
      }
    },
    {
      "id": "standard_architecture_command_rules.pattern.inspect_pattern",
      "category": "architectural_pattern",
      "statement": "Must follow the inspect_pattern pattern structure.",
      "enforcement": "error",
      "rationale": "Query system state without side effects",
      "check": {
        "engine": "llm_gate",
        "params": {}
      }
    },
    {
      "id": "standard_architecture_command_rules.pattern.action_pattern",
      "category": "architectural_pattern",
      "statement": "Must follow the action_pattern pattern structure.",
      "enforcement": "error",
      "rationale": "Modify system state with safety guarantees",
      "check": {
        "engine": "llm_gate",
        "params": {}
      }
    },
    {
      "id": "standard_architecture_command_rules.pattern.check_pattern",
      "category": "architectural_pattern",
      "statement": "Must follow the check_pattern pattern structure.",
      "enforcement": "error",
      "rationale": "Validate system state against policies",
      "check": {
        "engine": "llm_gate",
        "params": {}
      }
    },
    {
      "id": "standard_architecture_command_rules.pattern.run_pattern",
      "category": "architectural_pattern",
      "statement": "Must follow the run_pattern pattern structure.",
      "enforcement": "error",
      "rationale": "Execute autonomous operations or workflows",
      "check": {
        "engine": "llm_gate",
        "params": {}
      }
    },
    {
      "id": "standard_architecture_command_rules.pattern.manage_pattern",
      "category": "architectural_pattern",
      "statement": "Must follow the manage_pattern pattern structure.",
      "enforcement": "error",
      "rationale": "Administer system resources and configuration",
      "check": {
        "engine": "llm_gate",
        "params": {}
      }
    }
  ],
  "anti_patterns": {
    "forbidden": [
      {
        "pattern": "Hidden side effects in inspect commands",
        "reason": "Breaks read-only guarantee"
      },
      {
        "pattern": "Action commands that default to --write",
        "reason": "Violates safety-first principle"
      },
      {
        "pattern": "Commands that mix multiple patterns",
        "reason": "Creates confusion about guarantees"
      },
      {
        "pattern": "Silent failures (exit code 0 when failed)",
        "reason": "Breaks workflow composition"
      },
      {
        "pattern": "Non-atomic operations without rollback",
        "reason": "Can leave system in inconsistent state"
      }
    ]
  },
  "enforcement": {
    "automated_checks": [
      "All CLI commands must declare their pattern in docstring",
      "Pattern checker validates implementation matches guarantees",
      "CI rejects commands that violate pattern contracts"
    ],
    "human_review": [
      "New command patterns require constitutional amendment",
      "Pattern violations in PRs block merge"
    ]
  },
  "migration_guide": {
    "existing_commands": [
      "Audit all commands against patterns",
      "Tag each with correct pattern_id",
      "Fix violations (add --dry-run defaults, etc.)",
      "Add pattern compliance to dev-sync"
    ],
    "new_commands": [
      "Choose pattern first",
      "Implement to pattern specification",
      "Include pattern_id in command metadata",
      "Verify with pattern checker before commit"
    ]
  },
  "additionalProperties": false
}
