{
  "id": "standard_architecture_body_contracts",
  "version": "1.2.3",
  "title": "Architecture Standard â€“ Body Contracts",
  "type": "policy",
  "status": "active",
  "owners": {
    "accountable": "Architecture Owner",
    "responsible": [
      "Core Maintainer"
    ]
  },
  "review": {
    "frequency": "12 months"
  },
  "schema_id": "schema.policy",
  "description": "Defines behavioral rules for all Body-layer code. Enforces headless execution, safe-by-default writes, and predictable result contracts.",
  "scope": {
    "applies_to": [
      "src/features/**/*.py",
      "src/services/**/*.py",
      "src/body/atomic/**/*.py",
      "src/shared/infrastructure/**/*.py"
    ]
  },
  "rules": [
    {
      "id": "body.no_ui_imports_in_body",
      "rationale": "Body modules must be headless. CLI/API layers are exempted as they define the User Interface.",
      "enforcement": "error",
      "statement": "Body modules MUST NOT import Rich UI components (Console, Progress, etc.)",
      "scope": {
        "applies_to": [
          "src/**/*.py"
        ],
        "excludes": [
          "src/body/cli/**",
          "src/api/**",
          "src/mind/enforcement/**",
          "src/will/cli_logic/**",
          "**/*_cli.py",
          "**/cli_*.py"
        ]
      },
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "import_boundary",
          "forbidden": [
            "rich",
            "click",
            "typer",
            "tkinter",
            "PyQt5",
            "prompt_toolkit"
          ]
        }
      }
    },
    {
      "id": "body.no_print_or_input_in_body",
      "rationale": "Direct I/O bypasses the structured ActionResult. Allowed in CLI/API entry points.",
      "enforcement": "error",
      "statement": "Body modules MUST NOT use print() or input() for user interaction",
      "scope": {
        "applies_to": [
          "src/**/*.py"
        ],
        "excludes": [
          "src/body/cli/commands/**",
          "src/body/cli/admin_cli.py",
          "src/body/cli/interactive.py",
          "src/will/cli_logic/**",
          "src/api/**"
        ]
      },
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "no_print_statements"
        }
      }
    },
    {
      "id": "body.write_defaults_false",
      "rationale": "Enforces safe-by-default behavior.",
      "enforcement": "error",
      "statement": "Any write/modify parameter in Body code MUST default to False",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "write_defaults_false"
        }
      }
    },
    {
      "id": "body.staged_writes_required",
      "statement": "Autonomous logic MUST stage writes via FileHandler, not write directly. Infrastructure is exempt.",
      "rationale": "A3 autonomy requires all writes to go through constitutional review in pending_writes before execution.",
      "enforcement": "error",
      "scope": {
        "applies_to": [
          "src/features/**/*.py",
          "src/body/atomic/**/*.py"
        ],
        "excludes": [
          "src/shared/infrastructure/**",
          "src/shared/processors/**"
        ]
      },
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "no_direct_writes",
          "forbidden_patterns": [
            "Path.write_text",
            "Path.write_bytes",
            "open(..., 'w')",
            "open(..., 'wb')"
          ],
          "allowed_alternative": "FileHandler.add_pending_write"
        }
      }
    },
    {
      "id": "body.atomic_actions_use_actionresult",
      "rationale": "Workflows require a consistent return object.",
      "enforcement": "error",
      "statement": "High-level Body actions exposed to workflows MUST return ActionResult",
      "scope": {
        "applies_to": [
          "src/features/**/*.py",
          "src/services/**/*.py",
          "src/body/atomic/**/*.py"
        ]
      },
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "generic_primitive",
          "selector": {
            "has_decorator": "atomic_action"
          },
          "requirement": {
            "check_type": "returns_type",
            "expected": "ActionResult"
          }
        }
      }
    },
    {
      "id": "body.no_envvar_access_in_body",
      "rationale": "Use shared.config.settings for governed configuration.",
      "enforcement": "warn",
      "statement": "Body modules MUST NOT call os.environ[...] directly; use shared.config.settings",
      "scope": {
        "applies_to": [
          "src/**/*.py"
        ],
        "excludes": [
          "src/body/cli/admin_cli.py",
          "src/api/main.py",
          "src/shared/config.py",
          "src/shared/logger.py"
        ]
      },
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "forbidden_primitives",
          "forbidden": [
            "os.environ",
            "os.getenv",
            "getenv"
          ]
        }
      }
    },
    {
      "id": "body.no_blocking_sleep",
      "rationale": "time.sleep blocks the event loop.",
      "enforcement": "error",
      "statement": "Avoid time.sleep and blocking calls in Body code; use asyncio.sleep.",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "forbidden_primitives",
          "forbidden": [
            "time.sleep"
          ]
        }
      }
    },
    {
      "id": "body.dependency_injection_preferred",
      "rationale": "Explicit dependencies required for unit testability.",
      "enforcement": "warn",
      "statement": "Body services SHOULD receive dependencies via constructor, not create them internally",
      "scope": {
        "applies_to": [
          "src/**/*.py"
        ],
        "excludes": [
          "src/body/cli/**",
          "src/api/**",
          "tests/**"
        ]
      },
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "no_import_time_async_singletons",
          "disallowed_calls": [
            "CognitiveService",
            "QdrantService",
            "GitService"
          ]
        }
      }
    },
    {
      "id": "body.actionresult_data_json_serializable",
      "rationale": "Ensures results can be serialized.",
      "enforcement": "error",
      "statement": "ActionResult.data MUST be JSON-serializable.",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "generic_primitive",
          "selector": {
            "has_decorator": "atomic_action"
          },
          "requirement": {
            "check_type": "actionresult_data_json_safe"
          }
        }
      }
    }
  ],
  "additionalProperties": false
}