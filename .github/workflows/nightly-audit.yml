name: Governance Checks

on:
  #  schedule:
  #    - cron: "15 2 * * *"   # 02:15 UTC nightly
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write # Add this permission to allow commenting on PRs

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: pipx install poetry
      - name: Install deps
        run: poetry install --no-interaction --no-root
      - name: Run self-audit
        id: audit
        run: |
          set +e
          # Run the audit and capture output to a file
          poetry run python -m src.core.capabilities &> audit_output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          # Make the output available for the next steps
          echo "output<<EOF" >> $GITHUB_OUTPUT
          cat audit_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- This block runs ONLY for scheduled nightly builds ---
      - name: Open/Update issue on failure (for Nightly run)
        if: github.event_name == 'schedule' && steps.audit.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const title = "‚ùå Nightly Constitutional Audit failed";
            const body = "The nightly audit failed. Please check CI logs for details.\n\n- Workflow: ${{ github.workflow }}\n- Run ID: ${{ github.run_id }}";
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, state: "open", labels: "ci,audit"
            });
            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title, body, labels: ["ci","audit"]
              });
            }

      # --- This block runs ONLY for scheduled nightly builds ---
      - name: Close issue on success (for Nightly run)
        if: github.event_name == 'schedule' && steps.audit.outputs.exit_code == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const title = "‚ùå Nightly Constitutional Audit failed";
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, state: "open", labels: "ci,audit"
            });
            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: existing.number, state: "closed"
              });
            }

      # --- This NEW block runs ONLY for Pull Requests ---
      - name: Post PR comment on failure (for PR run)
        if: github.event_name == 'pull_request' && steps.audit.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `
            #### üèõÔ∏è Constitutional Audit Failed
            This change introduces a violation of the CORE constitution.
            Please review the audit logs to resolve the issue.

            <details><summary>Audit Failure Details</summary>

            \`\`\`
            ${{ steps.audit.outputs.output }}
            \`\`\`
            </details>
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });
