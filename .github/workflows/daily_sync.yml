# .github/workflows/daily_sync.yml
# This workflow automates the daily constitutional synchronization process for CORE.

name: "Daily Constitutional Sync"

on:
  # Run automatically every day at 08:00 UTC
  schedule:
    - cron: '0 8 * * *'
  # Allow manual runs from the GitHub Actions UI
  workflow_dispatch:

jobs:
  sync-and-audit:
    name: "Sync, Audit, and Propose"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v6

      - name: "Set up Python and Poetry"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'poetry'

      - name: "Install Dependencies"
        run: poetry install

      - name: "Run Canonical Integration Sequence"
        # This command will auto-fix, sync the DB, and run a full audit.
        # It is designed to be safe to run on any state of the repository.
        run: |
          poetry run core-admin submit changes -m "chore(auto): Daily constitutional sync and audit"

      - name: "Create Pull Request if Changes Occur"
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(auto): Propose changes from daily constitutional sync"
          title: "ðŸ¤– Automated Constitutional Sync"
          body: |
            This PR was auto-generated by the Daily Constitutional Sync workflow.

            It contains automatically generated fixes and updates from the `core-admin submit changes` command. Please review and merge to maintain constitutional alignment.
          labels: "autonomy, chore"
          branch: "auto/constitutional-sync"
          delete-branch: true
