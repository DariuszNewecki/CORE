# .intent/charter/policies/agent_governance.yaml
policy_id: "18f048cb-b084-4faa-ac62-17fca55fed77"  # From agent_policy
id: agent_governance
version: "2.0.0"
title: "Agent Behavior & Autonomous Action Governance"
status: active
purpose: >
  Define how COREâ€™s agents may act, what they are forbidden to do, and how
  autonomous behavior is constrained by the constitution, governance, and
  safety rules.

# === CORE AGENT RULES ===
agent_rules:
  - id: agent.compliance.no_write_intent
    statement: "Agents MUST NOT write directly to '.intent/charter/**'."
    enforcement: error

  - id: agent.compliance.respect_cli_registry
    statement: "All tool invocations MUST route through registered CLI commands."
    enforcement: error

  - id: agent.execution.no_unverified_code
    statement: "MUST NOT execute/commit code without full validation pipeline."
    enforcement: error

  - id: agent.execution.require_runtime_validation
    statement: "All generated code MUST pass test suite before commit."
    enforcement: error

  - id: agent.reasoning.trace_required
    statement: "MUST produce inspectable trace for non-trivial tasks."
    enforcement: warn

# === AUTONOMY LANES ===
autonomy_lanes:
  micro_proposals:
    description: "Low-risk autonomous changes that can auto-approve"
    allowed_actions:
      - "autonomy.self_healing.fix_docstrings"
      - "autonomy.self_healing.format_code"
      - "autonomy.self_healing.fix_headers"
      # ... ALL original micro-proposal actions remain

    safe_paths:
      - "docs/**/*.md"
      - "tests/**/*.py"
      - "src/**/*.py"
      # ... ALL original safe paths remain

    forbidden_paths:
      - ".intent/**"
      - "src/system/governance/**"
      - "src/core/**"
      # ... ALL original forbidden paths remain

  full_amendments:
    description: "Changes requiring human review and quorum"
    requires:
      - "formal_proposal"
      - "approver_signatures"
      - "constitutional_audit"
      - "meet_quorum_requirements"

# === RESOURCE SELECTION ===
resource_selection:
  scoring_weights:
    cost: 0.5
    speed: 0.3
    quality: 0.1
    reasoning: 0.1
# .intent/charter/policies/code_standards.yaml
policy_id: "aaa0a228-125d-4013-bfed-c1b58cec0f66" # From original code_style_policy
id: code_standards
version: "2.2.1" # Version bump for simplified header-only rule
title: "Comprehensive Code Quality & Standards"
status: active
purpose: >
  Unified standards for code quality, style, naming, and refactoring patterns.
  Ensures consistent, maintainable, and safe code across the entire codebase.

# === CODE STYLE & FORMATTING ===
style_rules:
  - id: style.linter_required
    statement: "All changes MUST pass ruff (lint) before merge."
    enforcement: error
  - id: style.formatter_required
    statement: "All changes MUST be formatted by black; CI runs black --check."
    enforcement: error
  - id: style.docstrings_public_apis
    statement: "Public APIs MUST have docstrings summarizing intent and parameters."
    enforcement: warn
  - id: style.universal_helper_first
    statement: "Before creating new helpers, check shared.universal. Reuse or extend instead of duplicating."
    enforcement: warn
  - id: style.capability_id_placement
    statement: >
      Primary public symbols that represent distinct capabilities MUST have '# ID: <uuid>'
      tags directly above their definition. Private helpers MUST NOT receive capability IDs.
    enforcement: warn
  - id: style.import_order
    statement: "Imports MUST follow grouping/order and avoid unused imports (enforced by linter)."
    enforcement: warn
  - id: style.fail_on_style_in_ci
    statement: "CI MUST fail on style or lint violations (no auto-fixing in CI)."
    enforcement: error

# === FILE HEADER (PATH COMMENT) ===
file_header_rules:
  - id: layout.src_module_header
    statement: >
      Every Python module under 'src/' MUST start with a single file path comment
      that exactly matches its repo-root path, e.g. '# src/body/cli/admin_cli.py'.
      No other content may appear before this comment except optional leading
      blank lines.
    enforcement: error
    scope:
      - "src/**/*.py"
    details:
      example: "# src/body/cli/admin_cli.py"
      behavior:
        - "If a correct header exists as the first non-empty line, do nothing."
        - "If a header exists but is incorrect, replace it."
        - "If no header exists, insert a new one as the first non-empty line."

import_structure_rules:
  - id: layout.import_grouping
    statement: >
      Imports MUST be grouped in the canonical order: future imports, standard library,
      third-party packages, then internal modules. Mixed groups or interleaving are forbidden.
    enforcement: warn
    scope:
      - "src/**/*.py"
      - "tests/**/*.py"
    details:
      groups:
        - name: future
          examples:
            - "from __future__ import annotations"
        - name: stdlib
          examples:
            - "import os"
            - "from pathlib import Path"
        - name: third_party
          examples:
            - "import qdrant_client"
            - "import sqlalchemy"
            - "import typer"
        - name: internal
          examples:
            - "from shared.logger import getLogger"
            - "from services.git_service import GitService"
            - "from mind.governance.audit_context import AuditorContext"
            - "from will.orchestration.cognitive_service import CognitiveService"

# === CODE HEALTH & COMPLEXITY ===
health_standards:
  max_cognitive_complexity: 15
  max_nesting_depth: 4
  max_line_length: 120
  max_module_lloc: 300
  max_function_lloc: 80
  outlier_standard_deviations: 2.0
  enforce_dead_public_symbols: true

# === SYMBOL METADATA & CAPABILITIES ===
symbol_metadata_rules:
  - id: symbols.public_capability_id_and_docstring
    statement: >
      Public symbols that represent a capability (primary functions/classes not starting
      with '_') MUST have an '# ID: <uuid>' comment directly above the definition and
      MUST provide a meaningful docstring describing behavior and guarantees.
    enforcement: error
    scope:
      - "src/**/*.py"
    details:
      id_comment_format: "^#\\s*ID:\\s*[0-9a-fA-F-]{36}$"
      public_symbol_criteria:
        - "Name does not start with '_'"
        - "Exported as part of module's capability surface (e.g. referenced in manifests or used externally)."
      docstring_requirements:
        - "Summarize the behavior and main responsibilities."
        - "Document side-effects or external interactions when non-trivial."
  - id: symbols.private_helpers_no_id_required
    statement: >
      Private helpers (functions/classes starting with '_') MUST NOT receive capability
      IDs. They MAY have docstrings where non-trivial but are not required to.
    enforcement: warn
    scope:
      - "src/**/*.py"
    details:
      private_symbol_criteria:
        - "Name starts with '_'"
      rationale: >
        Capability IDs are reserved for traceable, externally meaningful symbols.
        Helper functions should not pollute the capability graph.

# === CAPABILITY LINTING ===
capability_rules:
  - id: caps.meaningful_description
    statement: "Capability descriptions MUST be specific and non-placeholder."
    enforcement: error
  - id: caps.owner_required
    statement: "Active capabilities MUST have an assigned owner (agent/team)."
    enforcement: error
  - id: caps.no_placeholder_text
    statement: "Descriptions such as 'TBD' or 'N/A' are forbidden."
    enforcement: error
  - id: caps.id_format
    statement: "Source code linkers MUST use the form '# ID: <uuid>'."
    enforcement: error

# === DEPENDENCY INJECTION ===
dependency_injection:
  - id: di.no_direct_instantiation
    statement: "Services and features MUST NOT directly instantiate other major services. Dependencies MUST be injected via the constructor."
    enforcement: error
    scope:
      - "src/features/**/*.py"
      - "src/services/**/*.py"
    # === START OF FIXED EXCLUSIONS ===
    # We are telling the auditor that this rule does not apply to test files,
    # and certain entrypoints like the admin CLI, which are allowed to wire up
    # the system manually.
    exclusions:
      - "src/body/cli/admin_cli.py"
      - "src/features/governance/runtime_validator.py"
      - "tests/**/*.py"
    # === END OF FIXED EXCLUSIONS ===
    forbidden_instantiations:
      - "CognitiveService"
      - "GitService"
      - "ConstitutionalAuditor"
      - "QdrantService"
      - "ActionRegistry"
      - "PlanExecutor"
      - "SelfHealingAdvisor"
      - "CapabilityInvoker"
      - "CoderAgent"
  - id: di.no_global_session_import
    statement: "Modules within 'features' and 'services' MUST NOT directly import `get_session`. The database session MUST be injected."
    enforcement: error
    scope:
      - "src/features/**/*.py"
      - "src/services/repositories/**/*.py"
    forbidden_imports:
      - "services.database.session_manager.get_session"
      - "services.repositories.db.engine.get_session"
  - id: di.constructor_injection_preferred
    statement: "Services SHOULD receive their dependencies through the `__init__` constructor, with type hints."
    enforcement: warn

# === NAMING CONVENTIONS (REFACTORED) ===
# This section is now fully self-contained. The auditor reads the scope and pattern from here.

naming_conventions:
  intent:
    - id: "intent.policy_file_naming"
      description: "All charter policy files must use snake_case and end with '.yaml'."
      enforcement: error
      scope: ".intent/charter/policies/*.yaml"
      pattern: "^[a-z0-9_]+\\.yaml$"
    - id: "intent.policy_schema_naming"
      description: "Schemas for policy files must end with '_policy_schema.json'."
      enforcement: error
      scope: ".intent/charter/schemas/*_policy_schema.json"
      pattern: "^[a-z0-9_]+_policy_schema\\.json$"
    - id: "intent.artifact_schema_naming"
      description: "Schemas for non-policy artifacts must end with '_schema.[json|yaml]'."
      enforcement: error
      scope: ".intent/charter/schemas/*"
      pattern: "^[a-z0-9_]+_schema\\.(json|yaml)$"
      exclusions:
        - "*_policy_schema.json"
    - id: "intent.prompt_file_naming"
      description: "All prompt files must use snake_case and end with '.prompt'."
      enforcement: error
      scope: ".intent/mind/prompts/*.prompt"
      pattern: "^[a-z0-9_]+\\.prompt$"
    - id: "intent.proposal_file_naming"
      description: "All proposal files must follow the 'cr-*.yaml' naming convention."
      enforcement: warn
      scope: ".intent/proposals/*.yaml"
      pattern: "^cr-[a-zA-Z0-9_-]+\\.yaml$"
      exclusions:
        - "README.md"
  code:
    - id: "code.python_module_naming"
      description: "All Python source files must use snake_case naming."
      enforcement: error
      scope: "src/**/*.py"
      pattern: "^[a-z0-9_]+\\.py$"
      exclusions:
        - "__init__.py"
    - id: "code.python_test_module_naming"
      description: "All Python test files must be prefixed with 'test_'."
      enforcement: error
      scope: "tests/**/*.py"
      pattern: "^test_[a-z0-9_]+\\.py$"
      exclusions:
        - "__init__.py"
        - "conftest.py"

# === REFACTORING PATTERNS ===
refactoring_patterns:
  - id: extract_function
    description: "Move coherent logic into new function with clear name and docstring."
    guardrails:
      - must_keep_behavior: true
      - add_unit_tests: true
      - run_audit: true
  - id: extract_module
    description: "Move related functions/classes into new module; update imports and domain boundaries."
    guardrails:
      - must_keep_behavior: true
      - update_import_map: true
      - run_audit: true
  - id: introduce_facade
    description: "Add a facade/API layer to hide complexity behind a small, stable surface."
    guardrails:
      - document_contract: true
      - avoid_breaking_changes: true
      - run_audit: true

refactoring_rules:
  - id: refactor.requires_tests
    statement: "Any refactor that changes public behavior MUST include tests or proof of equivalence."
    enforcement: error
  - id: refactor.update_capabilities
    statement: "When moving symbols, update capability tags and manifests accordingly."
    enforcement: warn
  - id: refactor.audit_after
    statement: "A constitutional audit MUST run after refactors before merge."
    enforcement: error

# === AUDIT HOOKS ===
audit_checks:
  - id: header_compliance
    description: >
      Verify that every src module has a correct file header comment in line with
      file_header_rules.layout.src_module_header (path comment matching repo-root path).
    scope:
      - "src/**/*.py"
    severity: error
    policy_ref:
      policy: code_standards
      rule: layout.src_module_header
    auto_fix:
      tool: "fix_header"
      prompt_path: ".intent/mind/prompts/fix_header.prompt"
      mode: "suggest_or_write"
policy_id: "1fb8949c-02db-486a-8b9d-556191456de3"  # From database_policy
id: data_governance
version: "2.0.1" # Version bump for enhanced detection metadata
title: "Data Management & Knowledge Source Governance"
status: active
purpose: >
  Unified governance for database as Single Source of Truth, secrets management,
  and knowledge source integrity.

# === DATABASE AS SSOT ===
database_ssot:
  engine:
    type: postgresql
    schema: core

  migrations:
    directory: sql
    order:
      - "001_consolidated_schema.sql"

  rules:
    - id: db.ssot_for_operational_data
      statement: "Database is authoritative source for all operational data. Files are read-only mirrors."
      enforcement: error

    - id: db.write_via_governed_cli
      statement: "All writes MUST originate from registered CLI commands."
      enforcement: error

    - id: db.domains_in_db
      statement: "Capability domains MUST be stored in and queried from database."
      enforcement: error

    - id: db.vector_index_in_db
      statement: "Vector index data MUST be stored in database with metadata."
      enforcement: error

    - id: db.cli_registry_in_db
      statement: "Canonical CLI commands MUST be stored in database."
      enforcement: error

    - id: db.llm_resources_in_db
      statement: "LLM resource manifest MUST be stored in database."
      enforcement: error

    - id: db.cognitive_roles_in_db
      statement: "Cognitive roles MUST be stored in database."
      enforcement: error

# === SECURITY & PRIVACY ===
security_rules:
  - id: db.privacy.no_pii_or_secrets
    statement: "Personal data and secrets MUST NOT be stored in operational tables."
    enforcement: error

  - id: db.privacy.masking
    statement: "Logs and audit records MUST redact tokens, keys, and secrets."
    enforcement: error

  - id: secrets.no_hardcoded_secrets
    statement: "Source code MUST NOT contain hardcoded secrets. Use environment variables."
    enforcement: error
    detection:
      # --- AMENDMENT START ---
      # This key tells the SecurityChecks engine which scanner to use.
      method: regex_scan
      # --- AMENDMENT END ---
      patterns:
        - "(A|B|S|G)K[0-9A-Za-z]{30,}"
        - 'password\s*[:=]\s*[''""].+[''""]'

  - id: secrets.redact_in_logs
    statement: "Logs and telemetry MUST redact sensitive data before persistence."
    enforcement: warn

# === KNOWLEDGE SOURCE INTEGRITY ===
knowledge_integrity:
  - id: knowledge.database_ssot
    statement: "Database is single source of operational truth for knowledge artifacts."
    enforcement: error

  - id: knowledge.limited_legacy_access
    statement: "Only explicitly allowed system tools may interact with legacy knowledge artifacts."
    enforcement: error
    allowed_access_paths:
      - "src/features/introspection/knowledge_graph_service.py"
      - "src/features/governance/checks/knowledge_source_check.py"

# === RETENTION & BACKUP ===
retention:
  audit_runs_days: 180
  cli_runs_days: 90
  capability_history_days: 365
  proposals_days: 1095

backup_restore:
  cadence: daily
  test_restore_quarterly: true# .intent/charter/policies/operations.yaml
policy_id: "a3e1b0c4-9f8d-4a7b-8c1d-6e5f4a3b2c1d"  # From workflows_policy
id: operations
version: "2.0.0"
title: "System Operations & Workflows"
status: active
purpose: >
  Unified operational policies for workflows, canary deployments, incident response,
  and developer fastpaths.

# === MANDATORY INTEGRATION WORKFLOW ===
integration_workflow:
  - id: "linkage.assign_ids"
    command: "core-admin fix ids --write"
    description: "Assign stable UUIDs to new public symbols."
    continues_on_failure: false

  - id: "linkage.duplicate_ids"
    command: "core-admin fix duplicate-ids --write"
    description: "Find and resolve duplicate '# ID:' tags."
    continues_on_failure: false

  - id: "ssot.sync_knowledge"
    command: "core-admin manage database sync-knowledge --write"
    description: "Synchronize codebase state with database SSOT."
    continues_on_failure: false

  - id: "quality.test_suite"
    command: "core-admin check tests"
    description: "Run full test suite to ensure all tests pass."
    continues_on_failure: false

  - id: "quality.coverage_check"
    command: "core-admin coverage check"
    description: "Verify test coverage meets constitutional minimum (75%)."
    continues_on_failure: false

  - id: "governance.audit"
    command: "core-admin check audit"
    description: "Run full constitutional audit on new state."
    continues_on_failure: false

# === SELF-HEALING ROUTINES ===
self_healing_routines:
  - id: "style.headers"
    command: "core-admin fix headers --write"
    description: "Enforce constitutional header conventions."

  - id: "docs.docstrings"
    command: "core-admin fix docstrings --write"
    description: "Add missing docstrings to public functions."

  - id: "quality.generate_tests"
    command: "core-admin coverage remediate"
    description: "Autonomously generate tests to restore coverage compliance."
    trigger: "coverage < 75%"

# === CANARY DEPLOYMENTS ===
canary:
  enabled: true
  scope:
    paths:
      - "src/**"
      - "cli/**"
      - "agents/**"
    modes:
      - "development"
      - "staging"

  abort_conditions:
    - "audit:level=error"
    - "tests:failed>0"
    - "latency:p95>threshold"

  metrics:
    - name: "audit.errors"
      threshold: 0
      direction: "less"
    - name: "tests.failed"
      threshold: 0
      direction: "less"

# === DEVELOPER FASTPATH ===
dev_fastpath:
  thresholds:
    max_changed_files: 20
    allow_intent_changes: false

  required_checks:
    - syntax
    - linter
    - formatter

  disallowed_paths:
    - ".intent/**"
    - "src/system/governance/**"

# === INCIDENT RESPONSE ===
incident_response:
  severity_levels:
    - low
    - medium
    - high
    - critical

  response_rules:
    - id: ir.triage_required
      statement: "All incidents MUST be triaged within 24h with severity and owner assigned."
      enforcement: error

    - id: ir.timeline
      statement: "Minimal timeline (what happened, when, who, evidence) MUST be recorded."
      enforcement: warn

    - id: ir.comms
      statement: "Notifications MUST be sent to maintainers for high/critical incidents."
      enforcement: warn

    - id: ir.postmortem
      statement: "High/critical incidents REQUIRE short postmortem with actions and owners."
      enforcement: warn

# === RUNTIME REQUIREMENTS ===
runtime_rules:
  - id: operations.runtime.env_vars_defined
    statement: "All environment variables marked as 'required' in the runtime_requirements policy MUST be set."
    enforcement: error# .intent/charter/policies/quality_assurance.yaml
policy_id: "7d4f8c9a-2e1b-4f6d-9a8c-3b5e7f1d2c4a"  # From quality_assurance_policy
id: quality_assurance
version: "2.0.0"
title: "Quality Assurance & Evaluation Framework"
status: active
purpose: >
  Unified quality standards including test coverage mandates, autonomous remediation,
  and change evaluation scoring.

# === COVERAGE MANDATES ===
coverage_requirements:
  minimum_threshold: 75
  target_threshold: 80
  critical_paths:
    - "src/core/**/*.py: 85%"
    - "src/features/governance/**/*.py: 85%"
    - "src/features/self_healing/**/*.py: 80%"

  exclusions:
    - "src/**/__init__.py"
    - "src/**/models.py"
    - "tests/**/*.py"
    - "scripts/**/*.py"

  rules:
    - id: coverage.minimum_threshold
      statement: "Codebase MUST maintain minimum 75% test coverage for production code."
      enforcement: error

    - id: coverage.no_untested_commits
      statement: "No code changes shall reduce overall coverage below minimum without remediation plan."
      enforcement: error

    - id: coverage.auto_remediation
      statement: "When coverage falls below minimum, MUST trigger autonomous test generation."
      enforcement: error

# === AUTONOMOUS REMEDIATION ===
autonomous_remediation:
  trigger_conditions:
    - "coverage < minimum_threshold"
    - "new_uncovered_modules > 3"
    - "coverage_delta < -5%"

  phases:
    - phase: strategic_analysis
      actions:
        - "analyze_coverage_gaps"
        - "identify_critical_modules"
        - "generate_testing_strategy"

    - phase: test_generation
      actions:
        - "generate_test_code"
        - "validate_syntax_and_style"
        - "execute_tests"
        - "measure_coverage_improvement"

# === CHANGE EVALUATION ===
evaluation_framework:
  strategy: weighted_criteria

  criteria:
    - id: intent_alignment
      description: "Does this change serve a declared intent?"
      weight: 0.4

    - id: structural_compliance
      description: "Does it follow folder conventions and manifest structure?"
      weight: 0.2

    - id: safety
      description: "Was the change gated by a test or checkpoint?"
      weight: 0.2

    - id: code_quality
      description: "Does it pass formatting, linting, and basic semantic checks?"
      weight: 0.2

  thresholds:
    pass: 0.7
    warn: 0.5

# === RISK-TIER GATES ===
risk_tier_gates:
  medium:
    min_score: 0.80
    require:
      - checkpoint
      - canary

  high:
    min_score: 0.90
    require:
      - checkpoint
      - canary
      - approver_quorum

# === AUDIT CHECKLIST ===
audit_checklist:
  - id: declared_intent
    item: "Was the intent declared before the change?"
    required: true

  - id: explanation
    item: "Was the change explained or justified?"
    required: true

  - id: quality_verified
    item: "Was code quality verified post-write?"
    required: true

  - id: quorum_evidence
    item: "Quorum evidence recorded for medium/high risk changes"
    applies_when: "risk_tier in ['medium', 'high']"
    severity: "block"policy_id: "05ffbf34-2e0e-4069-b77e-473923537077"  # Kept from safety_policy
id: safety_framework
version: "2.0.1" # Version bump for enhanced detection metadata
title: "Safety & Constitutional Protection Framework"
status: active
purpose: >
  The single source of truth for all safety, security, and constitutional
  boundary protection. Merges safety_policy, intent_guard, and enforcement_model.

# === CONSTITUTIONAL BOUNDARIES (from intent_guard) ===
constitutional_boundaries:
  immutable_charter:
    statement: "The Charter (.intent/charter/**) is immutable. Changes require formal amendment."
    enforcement: error
    protected_paths:
      - ".intent/charter/**"

  single_active_constitution:
    statement: "Exactly one active constitution version MUST be referenced by '.intent/charter/constitution/ACTIVE'."
    enforcement: error

# === ENFORCEMENT MODEL (from enforcement_model) ===
enforcement_levels:
  error:
    description: "Critical violation. Blocks merge/deploy. Non-zero exit code."
    ci_behavior: "fail"
    runtime_behavior: "block"
  warn:
    description: "Non-critical issue. Reported but doesn't block."
    ci_behavior: "pass_with_warnings"
    runtime_behavior: "log_and_continue"
  info:
    description: "Informational finding. No action required."
    ci_behavior: "ignore"
    runtime_behavior: "ignore"

# === SAFETY RULES (from safety_policy) ===
safety_rules:
  - id: safety.immutable_constitution
    statement: "Core mission files are immutable without human-in-the-loop amendment process."
    enforcement: error
    protected_paths:
      - "mind/knowledge/domain_definitions.yaml"
      - "mind_export/northstar.yaml"

  - id: safety.deny_core_loop_edit
    statement: "Cannot modify core orchestration and governance engine without human review."
    enforcement: error
    protected_paths:
      - "src/core/main.py"
      - "src/core/intent_guard.py"
      - "charter/policies/safety_framework.yaml"  # Self-protection!

  - id: safety.no_dangerous_execution
    statement: "Generated code must not contain dangerous execution primitives."
    enforcement: error
    detection:
      # --- AMENDMENT START ---
      # This key tells the SecurityChecks engine which scanner to use.
      method: ast_call_scan
      # --- AMENDMENT END ---
      patterns:
        - "eval\\("
        - "exec\\("
        - "subprocess\\.(run|Popen|call)\\([^)]*shell\\s*=\\s*True"
    # ... keep ALL original safety patterns and exemptions

  - id: safety.change_must_be_logged
    statement: "Every file change must be preceded by a log entry with IntentBundle ID."
    enforcement: error
