# .intent/enforcement/mappings/will/planning.yaml
# Constitutional enforcement for planning phase - V2.3
# Status: READY FOR ENFORCEMENT

mappings:
  # 1. LAW: Planner must not generate code.
  # We use the LLM Gate (The Judge) for semantic "Understanding" without hard-coding.
  planning.no_code_generation:
    engine: llm_gate
    params:
      instruction: >
        Analyze the output of the Planner Agent.
        Verify that the 'params.code' field is null or empty.
        It is FORBIDDEN for the Planner to generate implementation code.
      rationale: "Strategic separation: The Planner defines 'what', the Coder defines 'how'."

  # 2. LAW: Plans must be conceptual only.
  # The Judge checks the 'params' dictionary for implementation details.
  planning.conceptual_only:
    engine: llm_gate
    params:
      instruction: >
        Check the 'params' dictionary of each execution task.
        It MUST NOT contain code patterns like 'def ', 'class ', 'import ', or 'return'.
        CRITICAL: Descriptions in the 'step' field may use these words naturally; only the 'params' dict is restricted.
      rationale: "Prevents strategy leakage into the implementation layer."

  # 3. LAW: Paths must be valid.
  # The Regex Gate (Deterministic) scans the code content for path-traversal bugs.
  planning.file_path_validation:
    engine: regex_gate
    params:
      # We check the content of the agent code for forbidden path patterns
      forbidden_patterns:
        - "src / " # Catches the 'spaces in path' bug
        - "\\\\\\\\" # Catches backslashes
      message: "Detected invalid path string format in logic."
    scope:
      applies_to:
        ["src/will/agents/planner_agent.py", "src/will/agents/base_planner.py"]

  # 4. LAW: Decisions must be traced.
  # The AST Gate (Deterministic) verifies the 'required_calls' verb we just implemented.
  planning.trace_mandatory:
    engine: ast_gate
    params:
      check_type: required_calls
      selector:
        # NEW: Only check methods that actually "do" things
        name_regex: "^(create_|execute_|elaborate_)"
      calls:
        - "self.tracer.record"
    scope:
      applies_to:
        [
          "src/will/agents/planner_agent.py",
          "src/will/agents/specification_agent.py",
        ]
