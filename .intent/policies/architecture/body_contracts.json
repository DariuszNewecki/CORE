{
  "id": "standard_architecture_body_contracts",
  "version": "1.1.0",
  "title": "Architecture Standard â€“ Body Contracts",
  "type": "policy",
  "status": "active",
  "owners": {
    "accountable": "Architecture Owner",
    "responsible": [
      "Core Maintainer"
    ]
  },
  "review": {
    "frequency": "12 months"
  },
  "schema_id": "meta.policy",
  "description": "Defines behavioral rules for all Body-layer code. Enforces headless execution, safe-by-default writes, and predictable result contracts.",
  "scope": {
    "applies_to": [
      "features/*/*_service.py",
      "features/*/logic/*",
      "services/*",
      "body/cli/logic/*",
      "body/cli/commands/*",
      "body/*/actions/*"
    ]
  },
  "rules": [
    {
      "id": "body.no_ui_imports_in_body",
      "rationale": "Body modules must be headless to allow for automated orchestration without a TTY.",
      "enforcement": "error",
      "statement": "Body modules MUST NOT import Rich UI components (Console, Progress, etc.)",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "import_boundary",
          "forbidden": [
            "rich",
            "click",
            "typer",
            "tkinter",
            "PyQt5",
            "prompt_toolkit"
          ]
        }
      }
    },
    {
      "id": "body.no_print_or_input_in_body",
      "rationale": "Direct I/O bypasses the structured ActionResult and logging systems.",
      "enforcement": "error",
      "statement": "Body modules MUST NOT use print() or input() for user interaction",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "no_print_statements"
        }
      }
    },
    {
      "id": "body.write_defaults_false",
      "rationale": "Enforces safe-by-default behavior; actions should not mutate unless explicitly told to.",
      "enforcement": "error",
      "statement": "Any write/modify parameter in Body code MUST default to False",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "write_defaults_false"
        }
      }
    },
    {
      "id": "body.atomic_actions_use_actionresult",
      "rationale": "Workflows require a consistent return object to handle success/failure logic.",
      "enforcement": "error",
      "statement": "High-level Body actions exposed to workflows MUST return ActionResult",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "generic_primitive",
          "selector": {
            "has_decorator": "atomic_action"
          },
          "requirement": {
            "check_type": "returns_type",
            "expected": "ActionResult"
          }
        }
      }
    },
    {
      "id": "body.no_envvar_access_in_body",
      "rationale": "Environment variables are global state. Use shared.config.settings for governed configuration.",
      "enforcement": "warning",
      "statement": "Body modules MUST NOT call os.environ[...] directly; use shared.config.settings",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "forbidden_primitives",
          "forbidden": [
            "os.environ",
            "os.getenv",
            "getenv"
          ]
        }
      }
    },
    {
      "id": "standard_architecture_body_contracts.testing_contract.4",
      "id_alias": "body.no_blocking_sleep",
      "rationale": "time.sleep blocks the event loop in async-native systems.",
      "enforcement": "error",
      "statement": "Avoid time.sleep and blocking calls in Body code; use asyncio.sleep.",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "forbidden_primitives",
          "forbidden": [
            "time.sleep"
          ]
        }
      }
    },
    {
      "id": "body.dependency_injection_preferred",
      "rationale": "Hardcoded instantiation makes units untestable and architecture rigid.",
      "enforcement": "warning",
      "statement": "Body services SHOULD receive dependencies via constructor, not create them internally",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "no_import_time_async_singletons",
          "disallowed_calls": [
            "CognitiveService",
            "QdrantService",
            "GitService"
          ]
        }
      }
    },
    {
      "id": "standard_architecture_body_contracts.action_results.3",
      "rationale": "Ensures results can be serialized for persistence or network transmission.",
      "enforcement": "error",
      "statement": "ActionResult.data MUST be JSON-serializable (no raw DB sessions, open files, etc.).",
      "check": {
        "engine": "ast_gate",
        "params": {
          "check_type": "generic_primitive",
          "selector": {
            "has_decorator": "atomic_action"
          },
          "requirement": {
            "check_type": "actionresult_data_json_safe"
          }
        }
      }
    }
  ],
  "additionalProperties": false
}
