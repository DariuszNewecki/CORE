policy_id: "05ffbf34-2e0e-4069-b77e-473923537077"  # Kept from safety_policy
id: safety_framework
version: "2.0.1"  # Version bump for enhanced detection metadata
title: "Safety & Constitutional Protection Framework"
status: active
purpose: >
  The single source of truth for all safety, security, and constitutional
  boundary protection. Merges safety_policy, intent_guard, and enforcement_model.

# === CONSTITUTIONAL BOUNDARIES (from intent_guard) ===
constitutional_boundaries:
  immutable_charter:
    statement: "The Charter (.intent/charter/**) is immutable. Changes require formal amendment."
    enforcement: error
    protected_paths:
      - ".intent/charter/**"

  single_active_constitution:
    statement: "Exactly one active constitution version MUST be referenced by '.intent/charter/constitution/ACTIVE'."
    enforcement: error

# === ENFORCEMENT MODEL (from enforcement_model) ===
enforcement_levels:
  error:
    description: "Critical violation. Blocks merge/deploy. Non-zero exit code."
    ci_behavior: "fail"
    runtime_behavior: "block"

  warn:
    description: "Non-critical issue. Reported but doesn't block."
    ci_behavior: "pass_with_warnings"
    runtime_behavior: "log_and_continue"

  info:
    description: "Informational finding. No action required."
    ci_behavior: "ignore"
    runtime_behavior: "ignore"

# === SAFETY RULES (from safety_policy) ===
safety_rules:

  - id: safety.immutable_constitution
    statement: "Core mission files are immutable without human-in-the-loop amendment process."
    enforcement: error
    protected_paths:
      - "mind/knowledge/domain_definitions.yaml"
      - "mind_export/northstar.yaml"

  - id: safety.deny_core_loop_edit
    statement: "Cannot modify core orchestration and governance engine without human review."
    enforcement: error
    protected_paths:
      - "src/core/main.py"
      - "src/core/intent_guard.py"
      - ".intent/charter/policies/safety_framework.yaml"  # Self-protection!

  - id: safety.no_dangerous_execution
    statement: "Generated code must not contain dangerous execution primitives."
    enforcement: error
    detection:
      method: ast_call_scan  # tells SecurityChecks which scanner to use
      patterns:
        - "eval\\("
        - "exec\\("
        - "subprocess\\.(run|Popen|call)\\([^)]*shell\\s*=\\s*True"
    # ... keep ALL original safety patterns and exemptions

  - id: safety.change_must_be_logged
    statement: "Every file change must be preceded by a log entry with IntentBundle ID."
    enforcement: error
