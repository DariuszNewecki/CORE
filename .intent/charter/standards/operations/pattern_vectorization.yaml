# .intent/charter/standards/operations/pattern_vectorization.yaml
id: standard_operations_pattern_vectorization
version: "1.0.0"
title: "Operations Standard â€“ Pattern Vectorization"
type: "standard_operations"
status: active

owners:
  accountable: "Governance Lead"
  responsible:
    - "Core Maintainer"

review:
  frequency: "12 months"

schema_id: "standard.operations.pattern_vectorization"

policy_id: pattern_vectorization

category: governance
layer: mind
depends_on:
  - knowledge_graph_integrity
  - semantic_infrastructure

# =============================================================================
# PHILOSOPHICAL FOUNDATION
# =============================================================================

philosophy: |
  Constitutional governance requires CORE to understand its own constitution
  at a semantic level, not just syntactic.

  Patterns are not documentation - they are normative definitions of how
  CORE must be structured. For CORE to self-govern, it must:

  1. Internalize patterns as semantic knowledge (vectorization)
  2. Understand code structure semantically (existing capability)
  3. Compare expectations vs reality (semantic validation)
  4. Report constitutional violations (delta between should-be and is)

  This is the foundation of self-awareness: CORE knows what it should be,
  sees what it actually is, and can report the difference constitutionally.

# =============================================================================
# CONSTITUTIONAL REQUIREMENTS
# =============================================================================

requirements:
  pattern_understanding:
    mandate: |
      CORE MUST maintain semantic understanding of all constitutional patterns
      defined in .intent/charter/patterns/.

    implementation:
      - "Vectorize all pattern YAML files into core-patterns collection"
      - "Each pattern section becomes a semantic chunk"
      - "Metadata includes pattern_id, version, category"
      - "Updates propagate when patterns change"

    validation:
      - "Query core-patterns returns relevant pattern sections"
      - "Semantic search works across pattern concepts"
      - "Pattern dependencies are tracked"

  semantic_validation:
    mandate: |
      CORE MUST be able to validate code against patterns semantically,
      not just syntactically.

    implementation:
      - "Pattern defines 'atomic action must have @decorator'"
      - "Query: 'Does fix_ids_internal have atomic_action decorator?'"
      - "Compare semantic embeddings of expectation vs reality"
      - "Report violations with constitutional references"

    validation:
      - "Can detect missing decorators"
      - "Can detect wrong return types"
      - "Can detect missing metadata"
      - "Can detect architectural violations"

  constitutional_audit:
    mandate: |
      CORE MUST audit itself against patterns and report violations
      with clear constitutional references.

    implementation:
      - "Audit reads pattern expectations"
      - "Audit queries actual code structure"
      - "Audit performs semantic comparison"
      - "Audit reports with pattern citations"

    validation:
      - "Violations reference specific pattern sections"
      - "Violations include remediation guidance"
      - "Violations are actionable"

# =============================================================================
# VECTOR COLLECTION: core-patterns
# =============================================================================

vector_collection:
  name: "core-patterns"
  purpose: "Semantic understanding of architectural patterns"

  collection_schema:
    vector_dimension: 1536  # text-embedding-3-small
    distance_metric: "cosine"

    metadata_schema:
      pattern_id:
        type: string
        required: true
        description: "Unique pattern identifier"
        example: "atomic_actions"

      pattern_version:
        type: string
        required: true
        description: "Pattern version"
        example: "1.0.0"

      pattern_category:
        type: string
        required: true
        description: "Pattern category"
        values: ["orchestration", "governance", "structure", "lifecycle"]

      section_type:
        type: string
        required: true
        description: "What part of pattern this chunk represents"
        values: ["philosophy", "requirement", "example", "validation_rule", "migration"]

      section_path:
        type: string
        required: true
        description: "Path within pattern YAML"
        example: "atomic_action.universal_contract.output"

      applies_to:
        type: array
        required: false
        description: "What code elements this applies to"
        example: ["*_internal functions", "workflow orchestrators"]

      severity:
        type: string
        required: false
        description: "Violation severity if not met"
        values: ["critical", "error", "warning", "info"]
        default: "error"

  chunking_strategy:
    approach: "semantic_section"
    description: |
      Each meaningful section of a pattern becomes a chunk.
      Sections are determined by YAML structure and semantic coherence.

    chunk_boundaries:
      - "Top-level keys (philosophy, requirements, examples)"
      - "Rule definitions within validation_rules"
      - "Individual examples"
      - "Migration phase descriptions"

    chunk_metadata:
      - "Include pattern context in each chunk"
      - "Include section hierarchy"
      - "Include cross-references"

    example:
      pattern_file: "atomic_actions.yaml"
      chunks:
        - content: "Philosophy section"
          metadata:
            section_type: "philosophy"
            section_path: "philosophy"

        - content: "Universal contract output requirements"
          metadata:
            section_type: "requirement"
            section_path: "atomic_action.universal_contract.output"
            applies_to: ["*_internal functions"]
            severity: "error"

        - content: "Workflow orchestration contract"
          metadata:
            section_type: "requirement"
            section_path: "workflow_orchestration.workflow_contract"
            applies_to: ["workflow orchestrators"]
            severity: "error"

  update_policy:
    trigger: "Pattern file modification detected"
    action: "Re-vectorize entire pattern file"
    validation: "Verify all chunks updated in collection"

# =============================================================================
# SEMANTIC VALIDATION WORKFLOW
# =============================================================================

validation_workflow:
  name: "Constitutional Pattern Validation"

  steps:
    1_load_pattern:
      action: "Load pattern expectations from core-patterns"
      input: "Pattern ID (e.g., 'atomic_actions')"
      output: "Pattern requirements as semantic chunks"
      query_example: |
        "What are the requirements for atomic actions?"
        Returns: All requirement chunks from atomic_actions pattern

    2_query_code:
      action: "Query actual code structure from knowledge graph"
      input: "Code scope (e.g., '*_internal functions')"
      output: "Current code structure"
      query_example: |
        SELECT name, signature, decorators, return_type
        FROM symbols
        WHERE name LIKE '%_internal'

    3_semantic_compare:
      action: "Compare expectations vs reality semantically"
      method: "Vector similarity + structural validation"
      logic: |
        For each requirement chunk:
          - Find relevant code symbols
          - Check if code satisfies requirement semantically
          - If similarity < threshold OR structure mismatch:
              Record violation

    4_report_violations:
      action: "Generate constitutional violation report"
      format:
        - violation_id: "Unique identifier"
        - pattern_reference: "Pattern section violated"
        - code_location: "Where violation occurs"
        - expected: "What pattern requires"
        - actual: "What code currently has"
        - remediation: "How to fix"
        - severity: "From pattern metadata"

  example_validation:
    pattern_requirement: |
      "All atomic actions must return ActionResult with fields:
       action_id, ok, data, duration_sec"

    code_query: |
      "Does fix_docstrings_internal return ActionResult?"

    semantic_check:
      - "Query function signature"
      - "Check return type annotation"
      - "Verify ActionResult structure"

    violation_if:
      - "Returns CommandResult (old contract)"
      - "Returns None"
      - "Returns unstructured dict"

    report:
      violation_id: "atomic_actions.contract.return_type.001"
      pattern_reference: ".intent/charter/patterns/atomic_actions.yaml#universal_contract.output"
      code_location: "src/body/cli/commands/fix/docstrings.py::fix_docstrings_internal"
      expected: "Return ActionResult with standard fields"
      actual: "Returns CommandResult (legacy contract)"
      remediation: "Change return type to ActionResult, add @atomic_action decorator"
      severity: "error"

# =============================================================================
# INTEGRATION WITH EXISTING SYSTEMS
# =============================================================================

integration:
  with_vectorization_service:
    action: "Extend VectorizationService to handle patterns"
    implementation: |
      class PatternVectorizer:
          def vectorize_pattern(self, pattern_file: Path) -> list[Chunk]:
              # Parse YAML
              # Chunk by semantic sections
              # Generate embeddings
              # Store in core-patterns collection
              pass

  with_audit_system:
    action: "Add pattern validation to constitutional audit"
    implementation: |
      async def audit_patterns() -> ActionResult:
          # Query core-patterns for requirements
          # Query knowledge graph for actual code
          # Perform semantic comparison
          # Report violations
          pass

  with_knowledge_graph:
    action: "Cross-reference patterns and code"
    queries:
      - "Which patterns apply to this symbol?"
      - "Which code violates this pattern?"
      - "What's the migration status for pattern X?"

# =============================================================================
# IMPLEMENTATION PHASES
# =============================================================================

implementation:
  phase_1_foundation:
    - "Create core-patterns Qdrant collection"
    - "Implement PatternVectorizer service"
    - "Vectorize existing 5 pattern files"
    - "Verify queries work"

  phase_2_validation:
    - "Create SemanticValidator service"
    - "Implement pattern-code comparison"
    - "Create violation reporter"
    - "Add to constitutional audit"

  phase_3_automation:
    - "Auto-vectorize on pattern changes"
    - "Real-time validation during development"
    - "Suggest remediations automatically"
    - "Track migration progress"

# =============================================================================
# SUCCESS CRITERIA
# =============================================================================

success_criteria:
  pattern_awareness:
    - "CORE can answer: 'What does atomic_actions pattern require?'"
    - "CORE can answer: 'Which functions violate atomic_actions pattern?'"
    - "CORE can answer: 'What's the migration status?'"

  semantic_validation:
    - "Detects missing @atomic_action decorators"
    - "Detects wrong return types"
    - "Detects missing metadata"
    - "Provides remediation guidance"

  constitutional_audit:
    - "Audit reports pattern violations"
    - "Citations reference specific pattern sections"
    - "Violations are actionable"
    - "Migration progress is trackable"

# =============================================================================
# GOVERNANCE
# =============================================================================

governance:
  pattern_authority:
    source: ".intent/charter/patterns/"
    immutability: "Patterns are constitutional - changes require governance process"
    versioning: "Pattern versions tracked, breaking changes flagged"

  validation_authority:
    source: "Constitutional audit system"
    enforcement: "Pattern violations reported but non-blocking during migration"
    escalation: "Violations become blocking after migration complete"

  override_policy:
    allowed: false
    rationale: "Patterns are constitutional - code must conform, not override"
    exception: "Exemptions documented in pattern file itself"

# =============================================================================
# REFERENCES
# =============================================================================

references:
  related_policies:
    - knowledge_graph_integrity.yaml
    - code_standards.yaml
    - quality_assurance.yaml

  related_patterns:
    - atomic_actions.yaml
