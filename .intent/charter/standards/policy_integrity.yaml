# .intent/charter/standards/policy_integrity.yaml
id: standard_policy_integrity
version: "1.0.0"
title: "Policy Integrity & Cross-Reference Standards"
type: "standard_policy_integrity"
status: active

owners:
  accountable: "Constitutional Governance"
  responsible:
    - "Core Maintainer"

review:
  frequency: "12 months"

schema_id: "standard.policy_integrity"

category: governance
severity: error

description: >
  Establishes rules for maintaining constitutional policy integrity, including
  how to handle duplicate rule IDs, cross-references between policies, and
  partial enforcement tracking.

  Supports the "High-Level + Implementation" pattern where the same rule ID
  appears in multiple files intentionally to link governance statements with
  technical specifications.

# =============================================================================
# DUPLICATE RULE ID RULES
# =============================================================================

duplicate_rule_id_rules:
  - id: policy.duplicate_rule_id_consistency
    statement: >
      When the same rule ID appears in multiple policy files, all instances
      MUST have consistent severity/enforcement levels.

    enforcement: error

    rationale: |
      Duplicate rule IDs are ALLOWED for cross-referencing (e.g., high-level
      governance statement in one file, detailed implementation in another).
      However, they must agree on severity to avoid confusion.

    examples:
      correct: |
        # agent_governance.yaml
        - id: agent.execution.no_unverified_code
          enforcement: error

        # code_execution.yaml
        - id: agent.execution.no_unverified_code
          severity: ERROR  # Same level, different key name (ok)

      incorrect: |
        # File A
        - id: some.rule
          enforcement: error

        # File B
        - id: some.rule
          enforcement: warn  # CONFLICT!

  - id: policy.cross_reference_documented
    statement: >
      When a rule ID appears in multiple files, at least one instance MUST
      document the cross-reference relationship.

    enforcement: warning

    rationale: |
      Without documentation, duplicate rule IDs look like mistakes rather than
      intentional design. Document the relationship to make intent clear.

    required_documentation_fields:
      - "cross_references"
      - "implementation_detail"
      - "governance_statement"
      - "see_also"
      - "related_rules"

    or_text_mention:
      - "see also"
      - "defined in"
      - "implemented in"
      - "specified in"
      - "detailed in"

    examples:
      good_practice: |
        # High-level governance file
        - id: agent.execution.no_unverified_code
          statement: "Agents must not execute unverified code"
          enforcement: error
          implementation_detail: "See code_execution.yaml for technical spec"

        # Detailed implementation file
        - id: agent.execution.no_unverified_code
          title: "Dangerous Functions Require Multi-Layer Protection"
          severity: ERROR
          governance_statement: "See agent_governance.yaml for policy context"
          description: |
            Detailed technical requirements including trust zones,
            validation layers, sandboxing requirements, etc.

# =============================================================================
# PARTIAL ENFORCEMENT TRACKING
# =============================================================================

partial_enforcement_rules:
  - id: policy.partial_enforcement_declared
    statement: >
      Rules with incomplete implementation MUST declare which aspects are
      enforced and which are missing.

    enforcement: info

    rationale: |
      Transparency about partial enforcement helps prioritize checker
      development and prevents false confidence in governance coverage.

    mechanism: |
      Rules can optionally include:

      enforcement_aspects:
        - aspect_name: "domain_restriction"
          status: "enforced"
          checker: "NoUnverifiedCodeCheck"

        - aspect_name: "ast_validation"
          status: "not_implemented"
          reason: "Requires AST inspection infrastructure"

      This metadata enables the coverage map to show "partially_enforced"
      status instead of binary enforced/declared.

    example: |
      - id: vector.sync_integrity
        statement: "No orphaned vectors or dangling links"
        enforcement: error

        enforcement_aspects:
          - name: "orphaned_vectors"
            status: "enforced"
            check: "VectorSyncCheck verifies no orphans in Qdrant"

          - name: "dangling_db_links"
            status: "not_implemented"
            reason: "Need bidirectional reference checker"

# =============================================================================
# CROSS-REFERENCE PATTERNS
# =============================================================================

cross_reference_patterns:
  high_level_plus_implementation:
    description: |
      One file contains governance statement (WHAT), another contains
      technical implementation (HOW). Same rule ID links them.

    use_when:
      - "Policy is simple statement but implementation is complex"
      - "Separating governance concern from technical details"
      - "Multiple teams own different aspects"

    template:
      governance_file: |
        - id: {rule_id}
          statement: "{high_level_requirement}"
          enforcement: {severity}
          implementation_detail: "See {impl_file} for technical spec"

      implementation_file: |
        - id: {rule_id}
          title: "{detailed_title}"
          severity: {severity}
          governance_statement: "See {gov_file} for policy context"
          description: |
            {detailed_technical_specification}
            {trust_zones}
            {validation_requirements}
            {examples}

    examples:
      - governance: "agent_governance.yaml"
        implementation: "code_execution.yaml"
        shared_rules:
          - "agent.execution.no_unverified_code"
          - "agent.execution.require_runtime_validation"

  domain_specific_enforcement:
    description: |
      Same rule applies across domains but with different specifics.
      Each domain file has same rule ID with domain-specific details.

    use_when:
      - "Rule applies universally but implementation varies by domain"
      - "Different teams enforce same principle differently"

    example: |
      # features/security_standards.yaml
      - id: security.input_validation
        domain: "features"
        requirements: ["whitelist_check", "length_limit", "type_check"]

      # api/security_standards.yaml
      - id: security.input_validation
        domain: "api"
        requirements: ["schema_validation", "rate_limiting", "auth_check"]

# =============================================================================
# ENFORCEMENT
# =============================================================================

enforcement_strategy:
  checker: "DuplicateRuleIdCheck"

  checks:
    - "Scan all .yaml files in .intent/charter/"
    - "Track rule IDs and their locations"
    - "Verify severity consistency for duplicates"
    - "Verify cross-reference documentation exists"
    - "Report violations as ERROR or WARNING"

  blocking_conditions:
    - "Duplicate rule IDs with conflicting severity (ERROR)"
    - "Duplicate rule IDs without documentation (WARNING)"

  auto_remediation:
    - "None - requires human judgment to resolve"
    - "Suggest adding cross_references field"
    - "Suggest consolidating if truly duplicate"
