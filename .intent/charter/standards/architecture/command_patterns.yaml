# .intent/charter/standards/architecture/command_patterns.yaml
id: standard_architecture_command_patterns
version: "1.0.0"
title: "Architecture Standard â€“ Command Patterns"
type: "standard_architecture"
status: active

owners:
  accountable: "Architecture Owner"
  responsible:
    - "Core Maintainer"

review:
  frequency: "12 months"

schema_id: "standard.architecture.command_patterns"

description: |
  Defines the canonical patterns for all CORE CLI commands.
  Every command MUST follow one of these patterns to ensure consistency,
  safety, and predictability across the system.

patterns:
  - pattern_id: "inspect_pattern"
    type: "read_only"
    purpose: "Query system state without side effects"

    signature:
      template: "core-admin inspect <resource> [options]"
      examples:
        - "core-admin inspect state"
        - "core-admin inspect workflows --active"
        - "core-admin inspect duplicates --threshold 0.96"
        - "core-admin inspect activity --last 1h"

    guarantees:
      - "No modifications to files, database, or vectors"
      - "Idempotent - can be called repeatedly safely"
      - "Fast response time (<5 seconds for simple queries)"
      - "Output to stdout/stderr only, never modifies disk"
      - "Returns structured data (JSON/YAML) when requested"

    parameters:
      allowed_flags:
        - "--format [json|yaml|table]"
        - "--filter <expression>"
        - "--limit <n>"
        - "--save <path>"  # Save output to file, doesn't modify system

      forbidden_flags:
        - "--write"
        - "--fix"
        - "--apply"

    implementation_requirements:
      - "Must be pure read operations"
      - "Should cache results when appropriate"
      - "Must handle missing data gracefully"
      - "Should provide progress indicators for long queries"

    exit_codes:
      0: "Success - query completed"
      1: "Error - query failed"
      2: "Warning - partial results returned"

  - pattern_id: "action_pattern"
    type: "read_write"
    purpose: "Modify system state with safety guarantees"

    signature:
      template: "core-admin <verb> <noun> [--dry-run|--write] [options]"
      examples:
        - "core-admin fix headers --dry-run"
        - "core-admin fix headers --write"
        - "core-admin manage policies sync --write"
        - "core-admin context rebuild --write"

    guarantees:
      - "Dry-run mode is DEFAULT (never destructive by accident)"
      - "Always preview changes before applying"
      - "Atomic operations (all or nothing)"
      - "Full audit trail of all modifications"
      - "Rollback capability for critical operations"

    parameters:
      required_behavior:
        default_mode: "dry-run"
        execution_flag: "--write"

      common_flags:
        - "--dry-run"      # Explicit dry-run (default)
        - "--write"        # Execute changes
        - "--force"        # Skip confirmations (requires --write)
        - "--backup"       # Create backup before changes

      forbidden_combinations:
        - "--dry-run --write"  # Mutually exclusive

    implementation_requirements:
      - "MUST show diff/preview in dry-run mode"
      - "MUST log all changes to audit system"
      - "MUST validate constitutional compliance before execution"
      - "MUST provide progress indication for multi-step operations"
      - "SHOULD support --confirm for interactive approval"

    phases:
      1_analyze: "Detect what needs to change"
      2_preview: "Show proposed changes (dry-run)"
      3_validate: "Check constitutional compliance"
      4_execute: "Apply changes (only if --write)"
      5_verify: "Confirm changes succeeded"
      6_audit: "Log to audit trail"

    exit_codes:
      0: "Success - changes applied (or dry-run completed)"
      1: "Error - operation failed"
      2: "Constitutional violation - blocked by policy"
      3: "User cancelled - interactive confirmation denied"

  - pattern_id: "check_pattern"
    type: "validation"
    purpose: "Validate system state against policies"

    signature:
      template: "core-admin check <aspect> [options]"
      examples:
        - "core-admin check audit"
        - "core-admin check lint"
        - "core-admin check patterns"
        - "core-admin check coverage --threshold 80"

    guarantees:
      - "No modifications (like inspect)"
      - "Returns clear pass/fail status"
      - "Provides actionable error messages"
      - "Exit code reflects validation status"

    parameters:
      common_flags:
        - "--quiet"        # Suppress output, exit code only
        - "--verbose"      # Detailed violation reports
        - "--json"         # Machine-readable output

      threshold_flags:
        - "--threshold <value>"  # For metrics-based checks

    implementation_requirements:
      - "MUST return non-zero exit code on validation failure"
      - "MUST provide specific violation details"
      - "SHOULD suggest remediation commands"

    exit_codes:
      0: "Pass - all checks succeeded"
      1: "Fail - violations detected"
      2: "Warning - non-critical issues found"

  - pattern_id: "run_pattern"
    type: "execution"
    purpose: "Execute autonomous operations or workflows"

    signature:
      template: "core-admin run <operation> [--write] [options]"
      examples:
        - "core-admin run vectorize --write"
        - "core-admin run self-heal --write"
        - "core-admin run coverage-repair --write"

    guarantees:
      - "Follows action_pattern safety model"
      - "Dry-run by default"
      - "Can involve multiple agents/services"
      - "Respects autonomy lane boundaries"

    parameters:
      execution_flags:
        - "--dry-run"      # Preview autonomous actions
        - "--write"        # Execute autonomous actions
        - "--interactive"  # Approve each step

      autonomy_flags:
        - "--lane <name>"  # Restrict to specific autonomy lane
        - "--max-steps <n>" # Limit autonomous iteration

    implementation_requirements:
      - "MUST operate within defined autonomy lanes"
      - "MUST get constitutional approval for actions"
      - "MUST log all autonomous decisions"
      - "SHOULD provide step-by-step progress"

    exit_codes:
      0: "Success - operation completed"
      1: "Error - operation failed"
      2: "Constitutional block - operation violated policy"
      3: "Autonomy limit reached - stopped safely"

  - pattern_id: "manage_pattern"
    type: "administration"
    purpose: "Administer system resources and configuration"

    signature:
      template: "core-admin manage <resource> <action> [options]"
      examples:
        - "core-admin manage database migrate --apply"
        - "core-admin manage policies sync --write"
        - "core-admin manage define-symbols"

    guarantees:
      - "Administrative operations for system maintenance"
      - "Follows action_pattern for state changes"
      - "Requires elevated consideration (affects infrastructure)"

    parameters:
      common_flags:
        - "--apply"        # For migrations
        - "--write"        # For sync operations
        - "--backup"       # Create backup first

    implementation_requirements:
      - "MUST validate system health before critical operations"
      - "MUST support rollback for schema changes"
      - "SHOULD warn about potential downtime"

workflow_composition:
  description: |
    Workflows (Makefile targets) compose multiple commands following these rules

  rules:
    - "Workflows can chain multiple action_pattern commands"
    - "Each step must succeed before proceeding to next"
    - "Workflows should be idempotent (safe to re-run)"
    - "Workflows should provide clear progress indication"
    - "Workflows should fail fast on errors"

  example:
    name: "dev-sync"
    steps:
      - command: "fix ids --write"
        pattern: "action_pattern"
      - command: "fix headers --write"
        pattern: "action_pattern"
      - command: "check lint"
        pattern: "check_pattern"
      - command: "inspect state --save snapshot.json"
        pattern: "inspect_pattern"

anti_patterns:
  forbidden:
    - pattern: "Hidden side effects in inspect commands"
      reason: "Breaks read-only guarantee"

    - pattern: "Action commands that default to --write"
      reason: "Violates safety-first principle"

    - pattern: "Commands that mix multiple patterns"
      reason: "Creates confusion about guarantees"

    - pattern: "Silent failures (exit code 0 when failed)"
      reason: "Breaks workflow composition"

    - pattern: "Non-atomic operations without rollback"
      reason: "Can leave system in inconsistent state"

enforcement:
  automated_checks:
    - "All CLI commands must declare their pattern in docstring"
    - "Pattern checker validates implementation matches guarantees"
    - "CI rejects commands that violate pattern contracts"

  human_review:
    - "New command patterns require constitutional amendment"
    - "Pattern violations in PRs block merge"

migration_guide:
  existing_commands:
    - "Audit all commands against patterns"
    - "Tag each with correct pattern_id"
    - "Fix violations (add --dry-run defaults, etc.)"
    - "Add pattern compliance to dev-sync"

  new_commands:
    - "Choose pattern first"
    - "Implement to pattern specification"
    - "Include pattern_id in command metadata"
    - "Verify with pattern checker before commit"
