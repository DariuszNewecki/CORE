policy_id: 05ffbf34-2e0e-4069-b77e-473923537077
id: safety_policy
version: "1.6.0" # Version bump for coverage module exemptions
title: "System Safety & Security Policy"
status: active
purpose: >
  The single source of truth for all security and safety policies governing
  code generation, execution, and self-modification.
scope:
  applies_to: [agents, code, ci, services]
owners:
  primary: "Security Lead"
  reviewers: ["Core Maintainer"]
review:
  frequency: "12 months"

rules:
  # ===================================================================
  # RULE: Govern Self-Modification (Immutable Constitution)
  # ===================================================================
  - id: immutable_constitution
    description: >
      The core mission files are immutable and can only be changed via the full,
      human-in-the-loop constitutional amendment process.
    enforcement: warn
    applies_to:
      paths:
        - "charter/mission/principles.yaml"
        - "charter/mission/manifesto.md"
        - "charter/mission/northstar.yaml"

  # ===================================================================
  # RULE: No self-modification of core loop
  # ===================================================================
  - id: deny_core_loop_edit
    description: >
      CORE cannot modify its own core orchestration and governance engine
      without explicit human review via the formal amendment process.
    enforcement: error
    applies_to:
      paths:
        - "src/core/main.py"
        - "src/core/intent_guard.py"
        - "charter/policies/intent_guard_policy.yaml"
        - "charter/policies/safety_policy.yaml"
    action: require_human_approval
    feedback: |
      üîí Core logic modification detected. Human review required before application.

  # ===================================================================
  # RULE: Block dangerous execution primitives
  # ===================================================================
  - id: no_dangerous_execution
    description: >
      Generated or modified code must not contain calls to dangerous functions
      that enable arbitrary code execution, shell access, or unsafe deserialization.
    enforcement: error
    scope:
      domains: [core, agents, features]
      exclude:
        - path: "tests/**"
          rationale: "Test files require direct execution for validation"
        - path: "src/core/git_service.py"
          rationale: >
            This file is exempt as it safely uses subprocess.run() without shell=True.
    detection:
      type: regex
      patterns:
        - "eval\\("
        - "exec\\("
        - "compile\\("
        - "os\\.system\\("
        - "os\\.popen\\("
        - "subprocess\\.(run|Popen|call)\\([^)]*shell\\s*=\\s*True"
        - "shutil\\.rmtree\\("
        - "os\\.remove\\("
        - "os\\.rmdir\\("
    action: reject
    feedback: |
      ‚ùå Dangerous execution detected: '{{pattern}}'. Use safe wrappers or avoid shell=True.

  # ===================================================================
  # RULE: Block dangerous imports
  # ===================================================================
  - id: no_unsafe_imports
    description: >
      Source code must not import modules that provide direct, unsafe access
      to the filesystem or subprocesses. The 'os' module is permitted for safe
      operations like 'os.getenv', as dangerous functions are blocked by the
      'no_dangerous_execution' rule.
    enforcement: error
    scope:
      exclude:
        # CONSTITUTIONAL EXEMPTIONS: These are the *only* modules
        # allowed to perform low-level system operations.
        - path: "src/shared/utils/subprocess_utils.py"
          rationale: "This is the sanctioned, safe wrapper for running subprocesses."
        - path: "src/core/git_service.py"
          rationale: "GitService is a sanctioned wrapper around the git subprocess."
        - path: "src/features/governance/runtime_validator.py"
          rationale: "Canary test runner requires subprocess to invoke pytest."
        - path: "src/core/test_runner.py"
          rationale: "The primary test runner needs subprocess to invoke pytest."
        - path: "src/cli/logic/chat.py"
          rationale: "Needs to run 'core-admin --help' to provide context to the LLM."
        - path: "src/features/project_lifecycle/bootstrap_service.py"
          rationale: "Needs to run 'gh' CLI for bootstrapping GitHub issues."
        - path: "src/features/project_lifecycle/integration_service.py"
          rationale: "The master workflow orchestrator needs to call other core-admin commands."
        - path: "src/services/repositories/db/common.py"
          rationale: "TECHNICAL DEBT: This low-level utility calls 'git' and should be refactored."
        - path: "src/core/ruff_linter.py"
          rationale: "The linter is a core tool that needs to run an external process."
        # ===================================================================
        # NEW EXEMPTIONS: Coverage Remediation System
        # ===================================================================
        - path: "src/features/self_healing/coverage_analyzer.py"
          rationale: "Needs subprocess to run pytest for coverage measurement."
        - path: "src/features/self_healing/test_generator.py"
          rationale: "Needs subprocess to execute generated tests for validation."
        - path: "src/features/governance/checks/coverage_check.py"
          rationale: "Needs subprocess to run pytest for constitutional coverage enforcement."
        - path: "src/cli/commands/coverage.py"
          rationale: "CLI commands need subprocess to invoke pytest for coverage reports."
        # ===================================================================
        - path: "scripts/**"
          rationale: "Developer scripts are exempt for utility purposes."
    detection:
      type: import_scan
      forbidden:
        # - "os" # Allowed for safe operations like getenv; dangerous calls are blocked separately.
        - "shutil"
        - "subprocess"

  # ===================================================================
  # RULE: Restrict network access
  # ===================================================================
  - id: restrict_network_access
    description: >
      Only explicitly allowed domains may be contacted. All outbound network
      calls must be through approved integration points.
    enforcement: error
    evidence: ["network_access_log"]
    allowed_domains:
      - "api.openai.com"
      - "github.com"
      - "api.deepseek.com"
      - "api.anthropic.com"
    action: reject
    feedback: |
      ‚ùå Attempt to contact unauthorized domain: {{domain}}. Update safety_policy.yaml to allow if needed.

  # ===================================================================
  # RULE: All changes must be logged
  # ===================================================================
  - id: change_must_be_logged
    description: >
      Every file change must be preceded by a log entry recorded at CORE_ACTION_LOG_PATH
      with IntentBundle ID and description.
    enforcement: error
    triggers:
      - before_write
    validator: change_log_checker
    action: reject_if_unlogged
    feedback: |
      ‚ùå No prior log entry found for this change. Write to CORE_ACTION_LOG_PATH before modifying files.
