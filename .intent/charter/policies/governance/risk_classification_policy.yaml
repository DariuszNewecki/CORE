# .intent/charter/policies/governance/risk_classification_policy.yaml
policy_id: a7f3c891-4d2e-4c19-9b77-8e5f2a3d6c42
id: risk_classification_policy
version: "1.0.0"
title: "Risk Tier Classification Policy"
status: active
purpose: >
  Defines the deterministic logic for assigning risk tiers to proposed changes.
  This is the authoritative source for risk assessment used by the auditor and
  constitutional review processes.
scope:
  applies_to: [auditor, intent_guard, constitutional_review]
owners:
  primary: "Security Lead"
  reviewers: ["Core Maintainer", "Platform SRE"]
review:
  frequency: "6 months"

# ============================================================================
# RISK TIER DEFINITIONS
# ============================================================================
tiers:
  routine:
    score: 1
    description: "Low-impact changes with minimal blast radius"
    examples: ["documentation updates", "test additions", "comment fixes"]

  standard:
    score: 2
    description: "Normal feature work with localized impact"
    examples: ["new feature", "bug fix in features/", "refactoring within domain"]

  elevated:
    score: 3
    description: "Changes affecting core system behavior or cross-domain logic"
    examples: ["agent modifications", "service layer changes", "DB schema updates"]

  critical:
    score: 4
    description: "Changes to governance, safety, or system identity"
    examples: ["constitution amendments", "safety policy changes", "approver modifications"]

# ============================================================================
# AUTOMATIC CLASSIFICATION RULES
# ============================================================================
# Rules are evaluated in order. First match wins.
# The auditor MUST apply these rules before checking score_policy thresholds.

classification_rules:
  # CRITICAL TIER
  - tier: critical
    conditions:
      any_of:
        - path_matches_any:
            source: "charter/constitution/critical_paths.yaml"
            rationale: "Constitutional definition of criticality"
        - path_pattern: "charter/policies/safety_policy.yaml"
        - path_pattern: "charter/constitution/approvers.yaml"
        - path_pattern: "charter/policies/governance/risk_classification_policy.yaml"
          rationale: "This file itself is critical (meta-rule)"
        - modifies_schema: true
          rationale: "Schema changes affect validation across the system"

  # ELEVATED TIER
  - tier: elevated
    conditions:
      any_of:
        - path_pattern: "src/core/**/*.py"
          exclude: ["src/core/**/*_test.py"]
          rationale: "Core orchestration layer"
        - path_pattern: "src/services/**/*.py"
          exclude: ["src/services/**/*_test.py"]
          rationale: "Infrastructure services"
        - path_pattern: "charter/policies/**/*.yaml"
          rationale: "Any policy change requires elevated scrutiny"
        - modifies_database_schema: true
          rationale: "Schema migrations have wide impact"
        - adds_new_capability: true
          rationale: "New capabilities alter system behavior"
        - touches_files_count: ">= 5"
          rationale: "Multi-file changes increase coupling risk"

  # STANDARD TIER
  - tier: standard
    conditions:
      any_of:
        - path_pattern: "src/features/**/*.py"
          exclude: ["src/features/**/*_test.py"]
        - path_pattern: "src/api/**/*.py"
        - path_pattern: "src/cli/**/*.py"
        - modifies_existing_capability: true
        - adds_dependency: true
          rationale: "New dependencies increase supply chain risk"

  # ROUTINE TIER (default fallback)
  - tier: routine
    conditions:
      any_of:
        - path_pattern: "**/*.md"
        - path_pattern: "**/*_test.py"
        - path_pattern: "tests/**/*"
        - path_pattern: "docs/**/*"
        - changes_only_comments: true
        - changes_only_whitespace: true

# ============================================================================
# RISK ESCALATION MODIFIERS
# ============================================================================
# These can bump a change up one tier if conditions are met.

escalation_modifiers:
  - condition: author_is_new_contributor
    escalate_by: 1
    rationale: "New contributors require additional review"

  - condition: fails_automated_tests
    escalate_by: 1
    rationale: "Broken tests indicate unexpected behavior"

  - condition: adds_network_call
    escalate_by: 1
    source_rule: "safety_policy.yaml#restrict_network_access"
    rationale: "Network calls increase attack surface"

  - condition: adds_execution_primitive
    escalate_to: critical
    source_rule: "safety_policy.yaml#no_dangerous_execution"
    rationale: "Always critical, regardless of location"

  - condition: no_tests_included
    escalate_by: 1
    applies_when: "tier >= standard"
    rationale: "Untested code in production paths is risky"

# ============================================================================
# OVERRIDE MECHANISM
# ============================================================================
# Human operators can override the automatic classification, but must justify.

override:
  allowed_by: ["approvers"]
  requires:
    - field: "risk_override_justification"
      min_length: 100
    - field: "risk_override_approver"
      must_match: "charter/constitution/approvers.yaml#approvers[].identity"
  audit_trail: true
  escalation_on_override:
    # If you override DOWN, you need MORE approval, not less
    downgrade_requires: "critical_quorum"
    upgrade_requires: "standard_quorum"

# ============================================================================
# VALIDATION RULES
# ============================================================================
validation:
  - id: risk_tier_must_be_assigned
    enforcement: error
    message: "Every proposal must have an assigned risk tier before review"

  - id: risk_tier_must_match_rules
    enforcement: error
    message: "Risk tier must match automatic classification unless explicitly overridden"

  - id: critical_tier_requires_critical_quorum
    enforcement: error
    links_to: "charter/constitution/approvers.yaml#quorum.critical"
