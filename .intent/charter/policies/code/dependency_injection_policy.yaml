policy_id: "a1b2c3d4-e5f6-7a8b-9c0d-e6f7a8b9c0d1"
id: dependency_injection_policy
version: "1.1.0" # Version bump for new category field
title: "Dependency Injection Policy"
status: active
purpose: >
  To enforce a strict Dependency Injection (DI) pattern across the service and
  feature layers. This ensures loose coupling, high testability, and a clear
  flow of dependencies from a single composition root.

scope:
  applies_to: [code, auditor]

owners:
  primary: "Core Maintainer"
  reviewers: ["Governance Lead"]

review:
  frequency: "annual"

rules:
  - id: di.no_direct_instantiation
    statement: "Services and features MUST NOT directly instantiate other major services. Dependencies MUST be injected via the constructor."
    enforcement: error
    category: architectural # <-- ADD THIS
    scope:
      - "src/features/**/*.py"
      - "src/services/**/*.py"
    exclusions:
      - "src/cli/admin_cli.py"
      - "src/features/governance/runtime_validator.py"
    forbidden_instantiations:
      - "CognitiveService"
      - "GitService"
      - "ConstitutionalAuditor"
      - "QdrantService"
      - "ActionRegistry"
      - "PlanExecutor"
      - "SelfHealingAdvisor"
      - "CapabilityInvoker"
      - "CoderAgent"

  - id: di.no_global_session_import
    statement: "Modules within 'features' and 'services' MUST NOT directly import `get_session`. The database session MUST be injected."
    enforcement: error
    category: architectural # <-- ADD THIS
    scope:
      - "src/features/**/*.py"
      - "src/services/repositories/**/*.py"
    forbidden_imports:
      - "services.database.session_manager.get_session"
      - "services.repositories.db.engine.get_session"

  - id: di.constructor_injection_preferred
    statement: "Services SHOULD receive their dependencies through the `__init__` constructor, with type hints."
    enforcement: warn
    category: architectural # <-- ADD THIS
