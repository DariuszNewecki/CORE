[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"

[tool.poetry]
name = "core"
version = "1.0.0"
description = "CORE: A self-governing, intent-driven software development system."
authors = ["Dariusz Newecki <d.newecki@gmail.com>"]
license = "MIT"
readme = "README.md"
packages = [
    { include = "api", from = "src" },
    { include = "body", from = "src" },
    { include = "features", from = "src" },
    { include = "mind", from = "src" },
    { include = "services", from = "src" },
    { include = "shared", from = "src" },
    { include = "will", from = "src" },
]

[tool.poetry.dependencies]
# Core Python version
python = "^3.12"

# Web Framework
fastapi = "^0.115.0"
uvicorn = {extras = ["standard"], version = "^0.32.0"}

# Database (Async)
sqlalchemy = {extras = ["asyncio"], version = "^2.0.36"}
asyncpg = "^0.30.0"
alembic = "^1.13.0"  # For database migrations

# Configuration & Validation
pydantic = "^2.11"
pydantic-settings = "^2.10.1"
python-dotenv = "^1.0.0"

# Security
cryptography = "^42.0.0"

# CLI & UI
typer = {extras = ["rich"], version = "^0.16.1"}
rich = "^13"

# Data Processing
pyyaml = "^6.0"
ruamel-yaml = "^0.18.6"
jsonschema = "^4"
httpx = "^0.28.0"

# Code Quality Tools
black = "^24"
radon = "^5.1.0"
sqlparse = "^0.5.3"

# Vector Database
qdrant-client = "^1.9.0"

# Scientific Computing
numpy = "^2.3.2"
scikit-learn = "^1.5.1"
scipy = "^1.14.0"

# Graph Analysis
networkx = "^3.3"

# Utilities
filelock = "^3.13.0"

# Dependency Injection (NEW)
dependency-injector = "^4.42.0"

# Observability (NEW - Optional)
opentelemetry-api = {version = "^1.21.0", optional = true}
opentelemetry-sdk = {version = "^1.21.0", optional = true}
opentelemetry-instrumentation-fastapi = {version = "^0.42b0", optional = true}
opentelemetry-instrumentation-sqlalchemy = {version = "^0.42b0", optional = true}

[tool.poetry.extras]
telemetry = [
    "opentelemetry-api",
    "opentelemetry-sdk",
    "opentelemetry-instrumentation-fastapi",
    "opentelemetry-instrumentation-sqlalchemy",
]

[tool.poetry.group.dev.dependencies]
# Testing
pytest = "^8.0"
pytest-asyncio = "^0.23.0"
pytest-mock = "^3.12.0"
pytest-cov = "^6.0"
pytest-dotenv = "^0.5.2"
aiosqlite = "^0.21.0"

# Code Quality
pre-commit = "^3.7.1"
mypy = "^1.11"
ruff = "^0.6.0"

# Documentation
sphinx = "^7.0"
sphinx-rtd-theme = "^2.0"

# Development Tools
httpx = "^0.28.1"
ipython = "^8.12"
anyio = "^4.11.0"
mkdocs = "^1.6.1"
mkdocs-material = "^9.7.0"

[tool.poetry.scripts]
core-admin = "body.cli.admin_cli:app"

[tool.black]
line-length = 88
target-version = ["py312"]
include = '\.pyi?$'
extend-exclude = '''
/(
    \.git
  | \.venv
  | __pycache__
  | logs
  | sandbox
  | pending_writes
)/
'''

[tool.ruff]
line-length = 88
target-version = "py312"
extend-exclude = [
    ".git",
    ".venv",
    "__pycache__",
    "logs",
    "sandbox",
    "pending_writes",
]

[tool.ruff.lint]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "UP",  # pyupgrade
]
ignore = [
    "E402",  # Module level import not at top of file
    "E501",  # Line too long (handled by black)
    "B008",  # Allow function calls in argument defaults (FastAPI/Typer pattern)
    "B904",  # Allow raise without 'from' in exception handlers
    "B007",  # Loop control variable not used
    "SIM102", # Allow nested if statements
    "SIM117", # Allow nested with statements
    "C401",  # Allow generator instead of set comprehension
    "C408",  # Allow dict() calls
    "C414",  # Allow list() in sorted()
    "N806",  # Allow uppercase variable names
    "UP038", # Allow isinstance with tuple (more readable than | syntax)
    "F841",  # Allow unused local variables (sometimes intentional)
]

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"]  # Unused imports in __init__.py
"tests/**/*.py" = [
    "B008",  # Do not perform function calls in argument defaults
    "F403", # Allow star imports in test files for resilience
]

[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false  # Start lenient, tighten later
ignore_missing_imports = true
plugins = ["pydantic.mypy"]

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false

[tool.pytest.ini_options]
testpaths = ["tests"]
env_files = ".env.test"
env_override_existing_values = "true"
asyncio_mode = "auto"
pythonpath = ["src"]
addopts = [
    "-v",
    "--strict-markers",
    "--strict-config",
    "--cov=src",
    "--cov-report=html",
    "--cov-report=term-missing:skip-covered",
    "-m", "not trio"
]
markers = [
    "unit: Unit tests (fast, no external dependencies)",
    "integration: Integration tests (database, external services)",
    "e2e: End-to-end tests (full system)",
    "slow: Slow running tests",
    "trio: marks tests to run with trio backend (skipped by default)",
]


[tool.coverage.run]
source = ["src"]
omit = [
    "*/tests/*",
    "*/__pycache__/*",
    "*/site-packages/*",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstract",
]
